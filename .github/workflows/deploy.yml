name: Deploy Riven Web

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Copy repo to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "./"
        target: "/opt/jellyfin-refresh"
        overwrite: true
        rm: false

    - name: Install dependencies & restart service
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          cd /opt/jellyfin-refresh

          # Create virtual env if missing
          if [ ! -d ".venv" ]; then
            python3 -m venv .venv
          fi

          # Activate
          source .venv/bin/activate

          # Install/update deps
          pip install -r requirements.txt

          # Copy systemd file
          sudo cp jellyfin-refresh.service /etc/systemd/system/jellyfin-refresh.service
          sudo systemctl daemon-reload
          sudo systemctl enable jellyfin-refresh.service

          # Restart the service
          sudo systemctl restart jellyfin-refresh.service

          echo "Deployment complete!"
