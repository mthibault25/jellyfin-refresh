name: Test SSH Connectivity

on:
  workflow_dispatch:

jobs:
  ssh-test:
    runs-on: ubuntu-latest

    steps:
    - name: Show masked host length (sanity check)
      run: |
        echo "SERVER_HOST length: ${#SERVER_HOST}"
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}

    - name: DNS Resolution Test
      run: |
        echo "Testing DNS resolution for host..."
        nslookup "$SERVER_HOST" || true
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}

    - name: Ping Test (if allowed)
      run: |
        echo "Attempting ping..."
        ping -c 4 "$SERVER_HOST" || echo "Ping failed (may be normal if ICMP blocked)."
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}

    - name: Check if port 22 is reachable
      run: |
        echo "Testing TCP connectivity on port 22..."
        timeout 5 bash -c "echo > /dev/tcp/$SERVER_HOST/22" \
          && echo "Port 22 is OPEN!" \
          || echo "Port 22 is CLOSED or BLOCKED."
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}

    - name: Check if port 2222 is reachable
      run: |
        echo "Testing TCP connectivity on port 2222..."
        timeout 5 bash -c "echo > /dev/tcp/$SERVER_HOST/2222" \
          && echo "Port 2222 is OPEN!" \
          || echo "Port 2222 is CLOSED or BLOCKED."
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}

    - name: SSH Attempt on Port 22 (verbose)
      run: |
        echo "Attempting SSH on port 22..."
        ssh -vvv -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            -p 22 \
            mark@"$SERVER_HOST" "echo CONNECTED ON PORT 22" \
            || echo "SSH on port 22 failed."
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}

    - name: SSH Attempt on Port 2222 (verbose)
      run: |
        echo "Attempting SSH on port 2222..."
        ssh -vvv -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            -p 2222 \
            mark@"$SERVER_HOST" "echo CONNECTED ON PORT 2222" \
            || echo "SSH on port 2222 failed."
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
