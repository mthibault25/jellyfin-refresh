name: Build and Deploy via Tailscale SSH

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/jellyfin-refresh:latest

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale and authenticate
        env:
          TS_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sudo tailscale up --authkey=${TS_AUTH_KEY} --hostname=github-runner-deploy --accept-routes

      - name: Wait for Tailscale connectivity
        run: sleep 5

      - name: Setup SSH key
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          PRIVATE_SSH_KEY: ${{ secrets.REMOTE_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "${PRIVATE_SSH_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Add remote host to known_hosts to avoid interactive prompt
          if [ -n "${REMOTE_HOST}" ]; then
            ssh-keyscan -H ${REMOTE_HOST} >> ~/.ssh/known_hosts || true
          fi

      - name: Deploy to remote host over Tailscale SSH
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/jellyfin-refresh:latest
        run: |
          echo "Deploying to ${REMOTE_USER}@${REMOTE_HOST} via Tailscale SSH"
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} "bash -lc 'docker pull ${IMAGE}; if [ \"\$(docker ps -a -q -f name=^/jellyfin-refresh$)\" != \"\" ]; then echo "Existing container found: stopping and removing"; docker stop jellyfin-refresh || true; docker rm jellyfin-refresh || true; else echo "No existing container found; continuing"; fi; docker run -d --name jellyfin-refresh -p 5000:5000 --restart unless-stopped ${IMAGE}'"

      - name: Bring down Tailscale
        if: always()
        run: sudo tailscale down || true
