{% extends "layout.html" %}

{% block content %}
  <section class="col">
    <h2>Shows</h2>
    <div class="autocomplete">
      <label for="show-search">Search shows</label>
      <input id="show-search" type="text" placeholder="Start typing a show name..." autocomplete="off" />
      <div id="show-suggestions" class="suggestions" role="listbox" aria-label="Show suggestions"></div>
      <div id="show-actions" class="suggestion-actions" style="display:none">
        <a id="show-link" href="#">Open show page</a>
        <button id="show-refresh">Refresh this show</button>
      </div>
    </div>
  </section>

  <section class="col">
    <h2>Movies</h2>
    <div class="grid">
      <div class="autocomplete">
        <label for="movie-search">Search movies</label>
        <input id="movie-search" type="text" placeholder="Start typing a movie name..." autocomplete="off" />
        <div id="movie-suggestions" class="suggestions" role="listbox" aria-label="Movie suggestions"></div>
        <div id="movie-actions" class="suggestion-actions" style="display:none">
          <a id="movie-link" href="#">Open movie page</a>
          <button id="movie-refresh">Refresh this movie</button>
        </div>
      </div>
    </div>
  </section>

  <section class="actions">
    <h3>Actions</h3>
    <div class="actions-row">
      <button onclick="streamToPre('/run/refresh_shows_inc', null, 'output')">Incremental Shows</button>
      <button onclick="streamToPre('/run/refresh_movies_inc', null, 'output')">Incremental Movies</button>
      <button onclick="streamToPre('/run/refresh_all', null, 'output')">Full Refresh ALL</button>
    </div>
    <pre id="output" class="output"></pre>
  </section>
  <script id="shows-data" type="application/json">{{ shows | tojson | safe }}</script>
  <script id="movies-data" type="application/json">{{ movies | tojson | safe }}</script>
  <script>
  // Shows data from server (embedded as JSON to avoid template/js parsing issues)
  const SHOWS_DATA = JSON.parse(document.getElementById('shows-data').textContent);
  // Movies data from server
  const MOVIES_DATA = JSON.parse(document.getElementById('movies-data').textContent);

  const input = document.getElementById('show-search');
  const suggBox = document.getElementById('show-suggestions');
  const actions = document.getElementById('show-actions');
  const link = document.getElementById('show-link');
  const refreshBtn = document.getElementById('show-refresh');
  let selectedShow = null;

  // Movie elements
  const minput = document.getElementById('movie-search');
  const msuggBox = document.getElementById('movie-suggestions');
  const mactions = document.getElementById('movie-actions');
  const mlink = document.getElementById('movie-link');
  const mrefreshBtn = document.getElementById('movie-refresh');
  let selectedMovie = null;

  function clearSuggestions() {
    suggBox.innerHTML = '';
    suggBox.style.display = 'none';
  }

  function makeSuggestion(name) {
    const div = document.createElement('div');
    div.className = 'suggestion-item';
    div.setAttribute('role','option');
    div.textContent = name;
    div.addEventListener('click', () => selectShow(name));
    return div;
  }

  function makeMovieSuggestion(name) {
    const div = document.createElement('div');
    div.className = 'suggestion-item';
    div.setAttribute('role','option');
    div.textContent = name;
    div.addEventListener('click', () => selectMovie(name));
    return div;
  }

  function selectShow(name) {
    selectedShow = name;
    input.value = name;
    clearSuggestions();
    actions.style.display = 'block';
    // set link to open show page
    link.href = '/show/' + encodeURIComponent(name);
  }

  input.addEventListener('input', () => {
    const q = input.value.trim().toLowerCase();
    suggBox.innerHTML = '';
    if (!q) { clearSuggestions(); actions.style.display='none'; selectedShow=null; return }
    const matches = SHOWS_DATA.filter(s => s.toLowerCase().includes(q)).slice(0, 20);
    if (matches.length === 0) { clearSuggestions(); return }
    matches.forEach(m => suggBox.appendChild(makeSuggestion(m)));
    suggBox.style.display = 'block';
  });

  // movie input logic
  minput.addEventListener('input', () => {
    const q = minput.value.trim().toLowerCase();
    msuggBox.innerHTML = '';
    if (!q) { msuggBox.style.display='none'; mactions.style.display='none'; selectedMovie=null; return }
    const matches = MOVIES_DATA.filter(m => m.toLowerCase().includes(q)).slice(0,20);
    if (matches.length === 0) { msuggBox.style.display='none'; return }
    matches.forEach(m => msuggBox.appendChild(makeMovieSuggestion(m)));
    msuggBox.style.display = 'block';
  });

  // click outside to close
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.autocomplete')) {
      clearSuggestions();
    }
  });

  refreshBtn.addEventListener('click', (e) => {
    e.preventDefault();
    if (!selectedShow) return;
    streamToPre('/run/refresh_show', {'show': selectedShow}, 'output');
  });

  // movie selection and refresh
  function selectMovie(name) {
  selectedMovie = name;
  minput.value = name;
  msuggBox.innerHTML = '';
  msuggBox.style.display = 'none';
  mactions.style.display = 'block';

  // set link to open movie page
  mlink.href = '/movie/' + encodeURIComponent(name);
}

  mrefreshBtn.addEventListener('click', (e) => {
    e.preventDefault();
    if (!selectedMovie) return;
    streamToPre('/run/refresh_movie', {'movie': selectedMovie}, 'output');
  });
  </script>

  <style>
  .suggestions { border: 1px solid #ccc; max-height: 240px; overflow:auto; display:none; background:#fff; }
  .suggestion-actions a {
  margin-right: 8px;
  color: #0a66c2;
  text-decoration: none;
  font-weight: 600;
}
  .suggestion-item { padding:8px; cursor:pointer; }
  .suggestion-item:hover { background:#eee; }
  .suggestion-actions { margin-top:8px; }
  </style>
{% endblock %}
