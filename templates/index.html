{% extends "layout.html" %}

{% block content %}
  <section class="col">
    <h2>Shows</h2>
    <div class="autocomplete">
      <label for="show-search">Search shows</label>
      <input id="show-search" type="text" placeholder="Start typing a show name..." autocomplete="off" />
      <div id="show-suggestions" class="suggestions" role="listbox" aria-label="Show suggestions"></div>
      <div id="show-actions" class="suggestion-actions" style="display:none">
        <a id="show-link" href="#">Open show page</a>
        <button id="show-refresh">Refresh this show</button>
      </div>
    </div>
  </section>

  <section class="col">
    <h2>Movies</h2>
    <div class="grid">
      {% for m in movies %}
        <div class="card">
          <span>{{ m }}</span>
          <form onsubmit="event.preventDefault(); streamToPre('/run/refresh_movie', {'movie': '{{ m }}'}, 'output')">
            <button type="submit">Refresh this movie</button>
          </form>
        </div>
      {% endfor %}
    </div>
  </section>

  <section class="actions">
    <h3>Actions</h3>
    <div class="actions-row">
      <button onclick="streamToPre('/run/refresh_shows_inc', null, 'output')">Incremental Shows</button>
      <button onclick="streamToPre('/run/refresh_movies_inc', null, 'output')">Incremental Movies</button>
      <button onclick="streamToPre('/run/refresh_all', null, 'output')">Full Refresh ALL</button>
    </div>
    <pre id="output" class="output"></pre>
  </section>
  <script id="shows-data" type="application/json">{{ shows | tojson | safe }}</script>
  <script>
  // Shows data from server (embedded as JSON to avoid template/js parsing issues)
  const SHOWS_DATA = JSON.parse(document.getElementById('shows-data').textContent);

  const input = document.getElementById('show-search');
  const suggBox = document.getElementById('show-suggestions');
  const actions = document.getElementById('show-actions');
  const link = document.getElementById('show-link');
  const refreshBtn = document.getElementById('show-refresh');
  let selectedShow = null;

  function clearSuggestions() {
    suggBox.innerHTML = '';
    suggBox.style.display = 'none';
  }

  function makeSuggestion(name) {
    const div = document.createElement('div');
    div.className = 'suggestion-item';
    div.setAttribute('role','option');
    div.textContent = name;
    div.addEventListener('click', () => selectShow(name));
    return div;
  }

  function selectShow(name) {
    selectedShow = name;
    input.value = name;
    clearSuggestions();
    actions.style.display = 'block';
    // set link to open show page
    link.href = '/show/' + encodeURIComponent(name);
  }

  input.addEventListener('input', () => {
    const q = input.value.trim().toLowerCase();
    suggBox.innerHTML = '';
    if (!q) { clearSuggestions(); actions.style.display='none'; selectedShow=null; return }
    const matches = SHOWS_DATA.filter(s => s.toLowerCase().includes(q)).slice(0, 20);
    if (matches.length === 0) { clearSuggestions(); return }
    matches.forEach(m => suggBox.appendChild(makeSuggestion(m)));
    suggBox.style.display = 'block';
  });

  // click outside to close
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.autocomplete')) {
      clearSuggestions();
    }
  });

  refreshBtn.addEventListener('click', (e) => {
    e.preventDefault();
    if (!selectedShow) return;
    streamToPre('/run/refresh_show', {'show': selectedShow}, 'output');
  });
  </script>

  <style>
  .suggestions { border: 1px solid #ccc; max-height: 240px; overflow:auto; display:none; background:#fff; }
  .suggestion-item { padding:8px; cursor:pointer; }
  .suggestion-item:hover { background:#eee; }
  .suggestion-actions { margin-top:8px; }
  </style>
{% endblock %}
